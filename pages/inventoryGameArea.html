<html lang="en">

<head>
    <meta charset="UTF-8" lang="en">
    <style>
        :root {
            --textColor: #000000;
            --col1: #ffffff;
            --col2: #000000;
            --col3: #c3c3c3;
            --col4: #7f7f7f;
        }

        #inventoryMain {
            display: grid;
            grid-template-columns: 2fr 3fr;
            grid-gap: 20px;
            width: 100%;
            height: 100%;
            color: var(--textColor);
        }

        #inventoryLeft {
            align-items: center;
            justify-items: center;
            display: grid;
            grid-template-rows: 2fr 1fr;
            width: 100%;
            height: 100%;
        }

        #inventoryRight {
            align-items: center;
            justify-items: center;
            display: grid;
            grid-template-rows: 0.1fr 2fr 1fr;
            width: 100%;
            height: 100%;
        }

        #equipmentTop {
            flex-direction: row;
            justify-content: center;
            border: var(--col2) 3px solid;
            width: 95%;
            height: 95%;
        }
        
        #statsBottom {
            border: var(--col2) 3px solid;
            width: 95%;
            height: 95%;
        }
        
        .equipment-item {
            image-rendering: pixelated;
            background-size: cover;
            background-repeat: no-repeat;
            margin: 10px;
            width: 110px;
            height: 110px;
        }

        #inventoryTop {
            align-content: flex-start;
            display: flex;
            flex-wrap: wrap;
            overflow-y: auto;
            overflow-x: hidden;
            border: var(--col2) 3px solid;
            width: 95%;
            height: 100%;
        }

        #inventoryBottom {
            margin-top: -6px;
            border: var(--col2) 3px solid;
            width: 95%;
            height: 95%;
        }

        .grid-container {
            justify-items: center;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            width: 100%;
            height: 100%;
            max-width: 1200px;
        }

        .grid-item {
            image-rendering: pixelated;
            background-size: cover;
            background-repeat: no-repeat;
            background-color: var(--col3);
            border: 4px solid var(--col2);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 120px;
            width: 120px;
        }
        .grid-item .equipment-item {
            width: 120px;
            height: 120px;
            margin: 0;
        }
        .equipmentColumn3 {
            grid-template-rows: 1fr 1fr 1fr;
        }
        .equipmentColumn4 {
            grid-template-rows: 1fr 1fr 1fr 1fr;
        }
        .equipmentColumn4, .equipmentColumn3 {
            margin-left: -2px;
            margin-right: -2px;
            display: grid;
            align-items: center;
            justify-items: center;
            height: 100%;
            width: 100%;
        }
        #navBar {
            width: 95%;
        }
    </style>
</head>

<body>
    <div style="display: none;">
        this page is in english
    </div>
    <div id="inventoryMain">
        <div id="inventoryLeft">
            <div id="equipmentTop">
                <div class="grid-container">
                    <div id="equipmentColumn1" class="equipmentColumn3">
                        <div class="grid-item receptacle" data-itemtype="amulets">Amulet</div>
                        <div class="grid-item receptacle" data-itemtype="Hand" style="background-image: url('../assets/defaults/swords.png');"></div>
                        <div class="grid-item receptacle" data-itemtype="Ring">LRing</div>
                    </div>
                    <div id="equipmentColumn2" class="equipmentColumn4">
                        <div class="grid-item receptacle" data-itemtype="helmets" style="background-image: url('../assets/defaults/helmets.png');"></div>
                        <div class="grid-item receptacle" data-itemtype="chestplates" style="background-image: url('../assets/defaults/chestplates.png');"></div>
                        <div class="grid-item receptacle" data-itemtype="waists" style="background-image: url('../assets/defaults/waists.png');"></div>
                        <div class="grid-item receptacle" data-itemtype="boots" style="background-image: url('../assets/defaults/boots.png');"></div>
                    </div>
                    <div id="equipmentColumn3" class="equipmentColumn3">
                        <div class="grid-item receptacle" data-itemtype="gloves" style="background-image: url('../assets/defaults/gloves.png');"></div>
                        <div class="grid-item receptacle" data-itemtype="Hand" style="background-image: url('../assets/defaults/swords.png');"></div>
                        <div class="grid-item receptacle" data-itemtype="Ring">RRing</div>
                    </div>
                </div>
            </div>
            <div id="statsBottom"></div>
        </div>
        <div id="inventoryRight">
            <div id="navBar">
                <!-- add selector -->
            </div>
            <div id="inventoryTop" class="container">
            </div>
            <div id="inventoryBottom"></div>
        </div>
    </div>
    <script>
        const blocks = Array.from(document.querySelectorAll('.equipment-item'));
        const receptacles = document.querySelectorAll('.receptacle');
        const container = document.querySelector('.container');

        blocks.forEach(block => {
            block.addEventListener('dragstart', dragStart);
            block.addEventListener('dragend', dragEnd);
        });

        receptacles.forEach(receptacle => {
            receptacle.addEventListener('dragover', dragOver);
            receptacle.addEventListener('dragenter', dragEnter);
            receptacle.addEventListener('dragleave', dragLeave);
            receptacle.addEventListener('drop', drop);
        });

        container.addEventListener('dragover', dragOver);
        container.addEventListener('drop', dropToContainer);

        let originalParent = null;

        function dragStart(e) {
            e.dataTransfer.setData('block-id', e.target.id);
            originalParent = e.target.parentNode;
        }

        function dragEnd(e) {
        }

        function dragOver(e) {
            e.preventDefault();
        }

        function dragEnter(e) {
        }

        function dragLeave(e) {
        }

        function drop(e) {
            e.preventDefault();
            let target = e.target;
            // If the drop target is a block inside a receptacle, set the target to the receptacle
            if (target.classList.contains('equipment-item')) {
                target = target.parentNode;
            }
            const blockId = e.dataTransfer.getData('block-id');
            const block = document.getElementById(blockId);
            const currentBlockInReceptacle = target.querySelector('.equipment-item');

            if (target.classList.contains('receptacle') && (e.target.dataset.itemtype === block.dataset.itemtype || (e.target.dataset.itemtype === 'Hand' && ["swords", "axes", "shields", "bows", "staffs"].includes(block.dataset.itemtype)))) {
                target.style.backgroundImage = 'none';
                if (currentBlockInReceptacle && currentBlockInReceptacle !== block) {
                    container.appendChild(currentBlockInReceptacle);
                }
                target.appendChild(block);
            } else {
                container.appendChild(block);
            }
        }

        function dropToContainer(e) {
            e.preventDefault();
            const blockId = e.dataTransfer.getData('block-id');
            const block = document.getElementById(blockId);

            // Check if the block was originally in a receptacle
            if (originalParent.classList.contains('receptacle')) {
                originalParent.innerHTML = '';
                originalParent.style.backgroundImage = 'url(../assets/defaults/' + block.dataset.itemtype + '.png)';
            }

            container.appendChild(block);
        }

        function makeGearItem(itemData, idCount) {
            let div = document.createElement('div');
            div.id = idCount;
            div.classList.add('equipment-item');
            div.dataset.itemdata = JSON.stringify(itemData);
            div.draggable = true;
            div.dataset.itemtype = itemData.type;
            div.style.backgroundImage = `url('../assets/gear/${itemData.type}/${itemData.picture}.png')`;
            // context menue
            return div;
        }

        fetch('/get_gear', { method: 'POST', body: JSON.stringify({"session":getCookie("session")}) }).then(response => response.json()).then(data => {
            let idCount = 0;
            let parent = document.getElementById("inventoryTop");
            data.forEach(item => {
                if (item !== null) {
                    console.log(item);
                    let newGearItem = makeGearItem(item, idCount++);
                    parent.appendChild(newGearItem);
                    blocks.push(newGearItem);
                    newGearItem.addEventListener('dragstart', dragStart);
                    newGearItem.addEventListener('dragend', dragEnd);
                };
            });
        });
        
        fetch('/get_basic_user_data', { method: 'POST', body: JSON.stringify({"session":getCookie("session")}) }).then(response => response.json()).then(data => {
            const playerLevel = data.level;
            console.log(playerLevel);
        });

        function updatePlayerStats() {
            let playerStats = {mana: 100, health: 20, attack: 20, defense: 20, speed: 20};
            // TODO
            
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

    </script>
</body>

</html>